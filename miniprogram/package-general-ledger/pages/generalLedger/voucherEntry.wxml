<!-- pages/generalLedger/voucherEntry.wxml -->
<view class="container">
  <!-- å‡­è¯åŸºæœ¬ä¿¡æ¯ -->
  <view class="form-section">
    <view class="form-header">
      <text class="form-title">å‡­è¯å½•å…¥</text>
      <view class="form-actions">
        <button type="default" bindtap="openAIAssistant" class="ai-btn">
          <text class="ai-icon">ğŸ¤–</text>
          <text class="ai-text">AIè¾…åŠ©</text>
        </button>
      </view>
    </view>
    <view class="form-row">
      <view class="form-item">
        <text class="label">å‡­è¯ç¼–å·</text>
        <input type="text" disabled value="{{voucherNumber}}" class="input" />
      </view>
      <view class="form-item">
        <text class="label">å‡­è¯æ—¥æœŸ</text>
        <picker mode="date" value="{{voucherDate}}" bindchange="onDateChange" class="picker">
          <view class="picker-text">{{voucherDate}}</view>
        </picker>
      </view>
    </view>
  </view>
  
  <!-- å‡­è¯åˆ†å½• -->
  <view class="entries-section">
    <view class="entries-header">
      <view class="header-item">æ‘˜è¦</view>
      <view class="header-item">ä¼šè®¡ç§‘ç›®</view>
      <view class="header-item">å€Ÿæ–¹é‡‘é¢</view>
      <view class="header-item">è´·æ–¹é‡‘é¢</view>
      <view class="header-item">æ“ä½œ</view>
    </view>
    
    <view class="entries-list">
      <view wx:for="{{entries}}" wx:key="id" class="entry-row">
        <view class="entry-item">
          <input type="text" placeholder="æ‘˜è¦" value="{{item.description}}" bindinput="onDescriptionInput" data-entry-id="{{item.id}}" class="input" />
        </view>
        <view class="entry-item">
          <view class="account-select" bindtap="selectAccount" data-entry-id="{{item.id}}">
            <text class="account-text">{{item.accountName || 'é€‰æ‹©ç§‘ç›®'}}</text>
            <text class="arrow">â–¼</text>
          </view>
        </view>
        <view class="entry-item">
          <input type="number" placeholder="0.00" value="{{item.debit}}" bindinput="onDebitInput" data-entry-id="{{item.id}}" class="input amount" />
        </view>
        <view class="entry-item">
          <input type="number" placeholder="0.00" value="{{item.credit}}" bindinput="onCreditInput" data-entry-id="{{item.id}}" class="input amount" />
        </view>
        <view class="entry-item">
          <button size="mini" type="warn" bindtap="deleteEntry" data-entry-id="{{item.id}}" class="delete-btn">åˆ </button>
        </view>
      </view>
      
      <!-- è¾…åŠ©æ ¸ç®—é€‰æ‹©åŒºåŸŸ -->
      <view wx:for="{{entries}}" wx:key="id" class="aux-accounting-section" wx:if="{{item.accountId}}">
        <view class="aux-title">è¾…åŠ©æ ¸ç®—</view>
        <view class="aux-items">
          <view wx:for="{{item.auxAccountingTypes || []}}" wx:for-item="auxType" wx:key="auxType" class="aux-item">
            <text class="aux-label">{{auxType}}ï¼š</text>
            <view class="aux-select" bindtap="selectAuxAccounting" data-entry-id="{{item.id}}" data-aux-type="{{auxType}}">
              <text class="aux-value">{{item.auxAccounting[auxType] || 'é€‰æ‹©'}}</text>
              <text class="arrow">â–¼</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- æ·»åŠ åˆ†å½•æŒ‰é’® -->
    <view class="add-entry-btn">
      <button type="default" bindtap="addEntry" class="btn">+ æ·»åŠ åˆ†å½•</button>
    </view>
    
    <!-- åˆè®¡é‡‘é¢ -->
    <view class="total-section">
      <view class="total-row">
        <text class="total-label">åˆè®¡</text>
        <text class="total-amount">å€Ÿæ–¹ï¼š{{totalDebit}} å…ƒ</text>
        <text class="total-amount">è´·æ–¹ï¼š{{totalCredit}} å…ƒ</text>
        <text wx:if="{{isBalanced}}" class="balanced">å¹³è¡¡</text>
        <text wx:else class="unbalanced">ä¸å¹³è¡¡</text>
      </view>
    </view>
  </view>
  
  <!-- æ“ä½œæŒ‰é’® -->
  <view class="footer-buttons">
    <button type="default" bindtap="cancel" class="btn cancel">å–æ¶ˆ</button>
    <button type="primary" bindtap="saveVoucher" class="btn save" disabled="{{!isBalanced}}">ä¿å­˜å‡­è¯</button>
  </view>
  
  <!-- ä¼šè®¡ç§‘ç›®é€‰æ‹©å™¨ -->
  <view wx:if="{{showAccountPicker}}" class="account-picker-overlay" catchtap="cancelAccount">
    <view class="account-picker" catchtap="">
      <view class="picker-header">
        <text class="picker-title">é€‰æ‹©ä¼šè®¡ç§‘ç›®</text>
        <button size="mini" bindtap="cancelAccount" class="close-btn">å…³é—­</button>
      </view>
      <scroll-view scroll-y="true" class="account-list">
        <view wx:for="{{accounts}}" wx:key="_id" class="account-item" bindtap="confirmAccount" data-id="{{item._id}}" data-name="{{item.name}}">
          <text class="account-code">{{item.code}}</text>
          <text class="account-name">{{item.name}}</text>
          <text class="account-type">{{item.type === 'asset' ? 'èµ„äº§' : item.type === 'liability' ? 'è´Ÿå€º' : item.type === 'equity' ? 'æƒç›Š' : item.type === 'income' ? 'æ”¶å…¥' : 'è´¹ç”¨'}}</text>
        </view>
      </scroll-view>
    </view>
  </view>
  
  <!-- è¾…åŠ©æ ¸ç®—é€‰æ‹©å™¨ -->
  <view wx:if="{{showAuxPicker}}" class="aux-picker-overlay" catchtap="cancelAuxAccounting">
    <view class="aux-picker" catchtap="">
      <view class="picker-header">
        <text class="picker-title">é€‰æ‹©{{currentAuxTypeName}}</text>
        <button size="mini" bindtap="cancelAuxAccounting" class="close-btn">å…³é—­</button>
      </view>
      <scroll-view scroll-y="true" class="aux-list">
        <!-- å®¢æˆ·åˆ—è¡¨ -->
        <view wx:if="currentAuxType === 'customer'">
          <view wx:for="{{customers}}" wx:key="_id" class="aux-item" bindtap="confirmAuxAccounting" data-id="{{item._id}}" data-name="{{item.name}}">
            <text class="aux-name">{{item.name}}</text>
            <text class="aux-code">{{item.code}}</text>
          </view>
        </view>
        <!-- ä¾›åº”å•†åˆ—è¡¨ -->
        <view wx:if="currentAuxType === 'supplier'">
          <view wx:for="{{suppliers}}" wx:key="_id" class="aux-item" bindtap="confirmAuxAccounting" data-id="{{item._id}}" data-name="{{item.name}}">
            <text class="aux-name">{{item.name}}</text>
            <text class="aux-code">{{item.code}}</text>
          </view>
        </view>
        <!-- éƒ¨é—¨åˆ—è¡¨ -->
        <view wx:if="currentAuxType === 'department'">
          <view wx:for="{{departments}}" wx:key="_id" class="aux-item" bindtap="confirmAuxAccounting" data-id="{{item._id}}" data-name="{{item.name}}">
            <text class="aux-name">{{item.name}}</text>
            <text class="aux-code">{{item.code}}</text>
          </view>
        </view>
        <!-- é¡¹ç›®åˆ—è¡¨ -->
        <view wx:if="currentAuxType === 'project'">
          <view wx:for="{{projects}}" wx:key="_id" class="aux-item" bindtap="confirmAuxAccounting" data-id="{{item._id}}" data-name="{{item.name}}">
            <text class="aux-name">{{item.name}}</text>
            <text class="aux-code">{{item.code}}</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- AIè¾…åŠ©è®°è´¦æ¨¡æ€æ¡† -->
  <view class="ai-assistant-modal" wx:if="{{showAIAssistant}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">AIè¾…åŠ©å‡­è¯å½•å…¥</text>
        <view class="close-btn" bindtap="closeAIAssistant">âœ•</view>
      </view>
      <view class="modal-body">
        <view class="ai-input-section">
          <text class="input-label">æè¿°äº¤æ˜“</text>
          <textarea placeholder="ä¾‹å¦‚ï¼šæ”¯ä»˜æœ¬æœˆå·¥èµ„68450å…ƒ" bindinput="onAITradeInput" class="ai-textarea" value="{{aiTradeInput}}" />
        </view>
        <button class="ai-analyze-btn" bindtap="analyzeWithAI" disabled="{{loadingAI || !aiTradeInput}}">
          {{loadingAI ? 'AIåˆ†æä¸­...' : 'AIåˆ†æ'}}
        </button>
        <view class="ai-result-section" wx:if="{{aiAnalysisResult}}">
          <text class="result-label">AIåˆ†æç»“æœ</text>
          <view class="result-content">
            <view wx:for="{{aiAnalysisResult.entries}}" wx:key="index" class="result-entry">
              <text class="entry-description">{{item.description}}</text>
              <text class="entry-account">{{item.accountName}}</text>
              <text class="entry-amount">{{item.debit > 0 ? 'å€Ÿ: Â¥' + item.debit : 'è´·: Â¥' + item.credit}}</text>
            </view>
          </view>
          <button class="apply-result-btn" bindtap="applyAIResult">åº”ç”¨ç»“æœ</button>
        </view>
      </view>
    </view>
  </view>
</view>
