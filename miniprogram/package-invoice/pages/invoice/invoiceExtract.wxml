<!-- pages/invoice/invoiceExtract.wxml -->
<view class="container">
  <!-- 顶部导航 -->
  <view class="header">
    <view class="back-btn" bindtap="onBack">
      <text class="back-icon">←</text>
    </view>
    <view class="page-title">发票提取</view>
    <view class="header-placeholder"></view>
  </view>

  <!-- 提取步骤 -->
  <view class="steps-container">
    <block wx:for="{{steps}}" wx:key="id">
      <view class="step-item">
        <view class="step-circle {{item.status}}">
          <text class="step-number">{{item.id + 1}}</text>
        </view>
        <text class="step-name {{item.status}}">{{item.name}}</text>
        <view class="step-line" wx:if="{{index < steps.length - 1}}"></view>
      </view>
    </block>
  </view>

  <!-- 主要内容 -->
  <view class="content-container">
    <!-- 第一步：选择图片 -->
    <block wx:if="{{currentStep === 0}}">
      <view class="step-content">
        <!-- 提取方式选择 -->
        <view class="method-selector">
          <text class="method-title">提取方式</text>
          <radio-group class="radio-group" bindchange="onMethodChange">
            <label class="radio-item">
              <radio value="camera" checked="{{extractMethod === 'camera'}}" />
              <text>拍照</text>
            </label>
            <label class="radio-item">
              <radio value="album" checked="{{extractMethod === 'album'}}" />
              <text>相册</text>
            </label>
          </radio-group>
        </view>
        
        <!-- 选择图片按钮 -->
        <view class="select-image-section">
          <button 
            class="select-image-btn" 
            type="primary" 
            bindtap="chooseImage"
          >
            {{extractMethod === 'camera' ? '拍照提取' : '从相册选择'}}
          </button>
        </view>
        
        <!-- 说明文字 -->
        <view class="instruction">
          <text class="instruction-text">
            提示：请确保发票清晰可见，光线充足，避免遮挡重要信息。
          </text>
        </view>
      </view>
    </block>
    
    <!-- 第二步：提取信息 -->
    <block wx:if="{{currentStep === 1}}">
      <view class="step-content">
        <!-- 图片预览 -->
        <view class="image-preview-section">
          <image 
            class="preview-image" 
            src="{{imagePath}}" 
            mode="aspectFit"
            bindtap="previewImage"
          ></image>
        </view>
        
        <!-- 提取进度 -->
        <view class="extraction-progress">
          <view class="progress-title">
            <text>正在提取发票信息...</text>
          </view>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{progress}}%"></view>
          </view>
          <view class="progress-text">
            <text>{{progress}}%</text>
          </view>
        </view>
        
        <!-- 重新选择按钮 -->
        <view class="reselect-section">
          <button 
            class="reselect-btn" 
            type="default" 
            bindtap="rechooseImage"
          >
            重新选择图片
          </button>
        </view>
      </view>
    </block>
    
    <!-- 第三步：确认信息 -->
    <block wx:if="{{currentStep === 2}}">
      <view class="step-content">
        <!-- 图片预览 -->
        <view class="image-preview-section small">
          <image 
            class="preview-image" 
            src="{{imagePath}}" 
            mode="aspectFit"
            bindtap="previewImage"
          ></image>
        </view>
        
        <!-- 提取结果 -->
        <view class="extraction-result">
          <view class="result-title">
            <text>提取结果</text>
          </view>
          
          <!-- 发票基本信息 -->
          <view class="invoice-info">
            <view class="info-row">
              <text class="info-label">发票类型:</text>
              <text class="info-value">{{extractedInvoice.type === 'sale' ? '销售发票' : '采购发票'}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">发票号码:</text>
              <text class="info-value">{{extractedInvoice.invoiceNo}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">发票日期:</text>
              <text class="info-value">{{extractedInvoice.invoiceDate}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">合计金额:</text>
              <text class="info-value">¥{{extractedInvoice.totalAmount.toFixed(2)}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">合计税额:</text>
              <text class="info-value">¥{{extractedInvoice.totalTax.toFixed(2)}}</text>
            </view>
          </view>
          
          <!-- 发票明细 -->
          <view class="invoice-items">
            <view class="items-title">
              <text>明细项</text>
            </view>
            
            <view class="items-list">
              <block wx:for="{{extractedItems}}" wx:key="_id" wx:for-item="item">
                <view class="item-row">
                  <view class="item-name">{{item.name}}</view>
                  <view class="item-details">
                    <text class="item-quantity">{{item.quantity}}{{item.unit}}</text>
                    <text class="item-price">¥{{item.unitPrice.toFixed(2)}}</text>
                    <text class="item-amount">¥{{item.amount.toFixed(2)}}</text>
                  </view>
                </view>
              </block>
            </view>
          </view>
        </view>
        
        <!-- 操作按钮 -->
        <view class="action-buttons">
          <button 
            class="edit-btn" 
            type="default" 
            bindtap="editInvoiceInfo"
          >
            编辑信息
          </button>
          <button 
            class="save-btn" 
            type="primary" 
            bindtap="saveExtractedInvoice"
            loading="{{isProcessing}}"
            disabled="{{isProcessing}}"
          >
            保存发票
          </button>
        </view>
      </view>
    </block>
  </view>
</view>
