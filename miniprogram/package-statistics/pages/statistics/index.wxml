<view class="page-container">
  <view class="header-bar">
    <text class="page-title">ç»Ÿè®¡åˆ†æ</text>
    <view class="period-selector" bindtap="openPeriodPicker">
      <text class="period-text">{{selectedPeriod}}</text>
      <text class="period-arrow">â–¼</text>
    </view>
  </view>

  <scroll-view class="content-scroll" scroll-y>
    <view class="content-wrapper">
      <view class="type-tabs">
        <view class="tab-item {{statsType === 'month' ? 'active' : ''}}" bindtap="switchStatsType" data-type="month">æœˆåº¦</view>
        <view class="tab-item {{statsType === 'year' ? 'active' : ''}}" bindtap="switchStatsType" data-type="year">å¹´åº¦</view>
        <view class="tab-item ai-tab" bindtap="openAIAnalysis">ğŸ¤– AIåˆ†æ</view>
      </view>

      <view class="overview-card">
        <view class="overview-header">
          <text class="card-title">æ”¶æ”¯æ¦‚è§ˆ</text>
          <view class="refresh-btn" bindtap="refreshData">
            <text class="refresh-icon">ğŸ”„</text>
          </view>
        </view>
        <view class="overview-grid">
          <view class="overview-item income">
            <text class="item-label">{{statsType === 'month' ? 'æœ¬æœˆæ”¶å…¥' : 'æœ¬å¹´æ”¶å…¥'}}</text>
            <text class="item-value">Â¥{{periodIncome}}</text>
            <view class="item-trend {{incomeChange >= 0 ? 'up' : 'down'}}">
              <text>{{incomeChange >= 0 ? 'â†‘' : 'â†“'}}</text>
              <text>{{Math.abs(incomeChange).toFixed(1)}}%</text>
            </view>
          </view>
          <view class="overview-item expense">
            <text class="item-label">{{statsType === 'month' ? 'æœ¬æœˆæ”¯å‡º' : 'æœ¬å¹´æ”¯å‡º'}}</text>
            <text class="item-value">Â¥{{periodExpense}}</text>
            <view class="item-trend {{expenseChange <= 0 ? 'up' : 'down'}}">
              <text>{{expenseChange <= 0 ? 'â†“' : 'â†‘'}}</text>
              <text>{{Math.abs(expenseChange).toFixed(1)}}%</text>
            </view>
          </view>
          <view class="overview-item balance">
            <text class="item-label">{{statsType === 'month' ? 'æœ¬æœˆç»“ä½™' : 'æœ¬å¹´ç»“ä½™'}}</text>
            <text class="item-value">Â¥{{periodBalance}}</text>
            <view class="item-trend {{balanceChange >= 0 ? 'up' : 'down'}}">
              <text>{{balanceChange >= 0 ? 'â†‘' : 'â†“'}}</text>
              <text>{{Math.abs(balanceChange).toFixed(1)}}%</text>
            </view>
          </view>
        </view>
      </view>

      <view class="chart-section">
        <view class="section-header">
          <text class="section-title">æ”¶æ”¯åˆ†æ</text>
          <view class="chart-tabs">
            <view class="chart-tab {{chartType === 'pie' ? 'active' : ''}}" bindtap="switchChartType" data-type="pie">é¥¼å›¾</view>
            <view class="chart-tab {{chartType === 'bar' ? 'active' : ''}}" bindtap="switchChartType" data-type="bar">æŸ±çŠ¶å›¾</view>
          </view>
        </view>
        <view class="chart-wrapper">
          <canvas canvas-id="expensePieChart" class="chart-canvas" wx:if="{{chartType === 'pie'}}"></canvas>
          <canvas canvas-id="expenseBarChart" class="chart-canvas" wx:else></canvas>
        </view>
      </view>

      <view class="category-section">
        <view class="section-header">
          <text class="section-title">åˆ†ç±»ç»Ÿè®¡</text>
          <view class="category-tabs">
            <view class="category-tab {{categoryType === 'expense' ? 'active' : ''}}" bindtap="switchCategoryType" data-type="expense">æ”¯å‡º</view>
            <view class="category-tab {{categoryType === 'income' ? 'active' : ''}}" bindtap="switchCategoryType" data-type="income">æ”¶å…¥</view>
          </view>
        </view>
        <view class="category-list">
          <view class="category-item" wx:for="{{currentCategoryStats}}" wx:key="name">
            <view class="category-left">
              <view class="category-icon">{{item.icon}}</view>
              <view class="category-info">
                <text class="category-name">{{item.name}}</text>
                <text class="category-amount">Â¥{{item.amount}}</text>
              </view>
            </view>
            <view class="category-right">
              <text class="category-percent">{{item.percentage}}%</text>
            </view>
            <view class="category-bar">
              <view class="category-bar-fill" style="width: {{item.percentage}}%"></view>
            </view>
          </view>
          <view class="empty-state" wx:if="{{currentCategoryStats.length === 0}}">
            <text class="empty-text">æš‚æ— åˆ†ç±»æ•°æ®</text>
          </view>
        </view>
      </view>

      <view class="trend-section">
        <view class="section-header">
          <text class="section-title">è¶‹åŠ¿åˆ†æ</text>
        </view>
        <view class="trend-wrapper">
          <canvas canvas-id="trendChart" class="trend-canvas"></canvas>
        </view>
      </view>

      <view class="habits-section">
        <view class="section-header">
          <text class="section-title">æ¶ˆè´¹ä¹ æƒ¯</text>
        </view>
        <view class="habits-grid">
          <view class="habit-card">
            <text class="habit-icon">ğŸ“Š</text>
            <text class="habit-label">ä¸»è¦æ¶ˆè´¹</text>
            <text class="habit-value">{{habits.mainCategory}}</text>
          </view>
          <view class="habit-card">
            <text class="habit-icon">ğŸ“…</text>
            <text class="habit-label">æ¶ˆè´¹å¤©æ•°</text>
            <text class="habit-value">{{habits.consumptionDays}}å¤©</text>
          </view>
          <view class="habit-card">
            <text class="habit-icon">ğŸ’°</text>
            <text class="habit-label">æ—¥å‡æ¶ˆè´¹</text>
            <text class="habit-value">Â¥{{habits.dailyAverage.toFixed(2)}}</text>
          </view>
          <view class="habit-card">
            <text class="habit-icon">ğŸ“ˆ</text>
            <text class="habit-label">æ¶ˆè´¹è¶‹åŠ¿</text>
            <text class="habit-value {{habits.trend === 'up' ? 'up' : habits.trend === 'down' ? 'down' : ''}}">{{habits.trend === 'up' ? 'ä¸Šå‡' : habits.trend === 'down' ? 'ä¸‹é™' : 'ç¨³å®š'}}</text>
          </view>
        </view>
      </view>

      <view class="transactions-section">
        <view class="section-header">
          <text class="section-title">è¿‘æœŸäº¤æ˜“</text>
          <navigator url="/pages/record/index" class="more-link">æŸ¥çœ‹å…¨éƒ¨</navigator>
        </view>
        <view class="transactions-list">
          <view class="transaction-row" wx:for="{{periodRecords}}" wx:key="_id">
            <view class="transaction-icon">{{item.categoryIcon}}</view>
            <view class="transaction-info">
              <text class="transaction-name">{{item.description || item.category}}</text>
              <text class="transaction-date">{{formatDate(item.date)}}</text>
            </view>
            <text class="transaction-amount {{item.type === 'income' ? 'income' : 'expense'}}">{{item.type === 'income' ? '+' : '-'}}Â¥{{item.amount}}</text>
          </view>
          <view class="empty-state" wx:if="{{periodRecords.length === 0}}">
            <text class="empty-text">æš‚æ— äº¤æ˜“è®°å½•</text>
          </view>
        </view>
      </view>

      <view class="quick-functions-section">
        <view class="section-header">
          <text class="section-title">å¿«æ·åŠŸèƒ½</text>
        </view>
        <view class="functions-grid">
          <navigator url="/pages/generalLedger/index" class="function-card">
            <view class="function-icon-wrapper">
              <text class="function-icon">ğŸ“‹</text>
            </view>
            <text class="function-label">æ€»è´¦ç®¡ç†</text>
          </navigator>
          <navigator url="/pages/accountsReceivable/index" class="function-card">
            <view class="function-icon-wrapper">
              <text class="function-icon">ğŸ’°</text>
            </view>
            <text class="function-label">åº”æ”¶è´¦æ¬¾</text>
          </navigator>
          <navigator url="/pages/record/index" class="function-card">
            <view class="function-icon-wrapper">
              <text class="function-icon">âœï¸</text>
            </view>
            <text class="function-label">æ–°å¢è®°å½•</text>
          </navigator>
        </view>
      </view>

      <view class="ai-insight-section" wx:if="{{aiAnalysisResult}}">
        <view class="section-header">
          <text class="section-title">AIåˆ†ææ´å¯Ÿ</text>
          <view class="refresh-btn" bindtap="analyzeReportWithAI">
            <text class="refresh-icon">ğŸ”„</text>
          </view>
        </view>
        <view class="insight-card">
          <text class="insight-text">{{aiAnalysisResult}}</text>
        </view>
      </view>
    </view>
  </scroll-view>
</view>

<view class="ai-modal" wx:if="{{showAIAnalysis}}">
  <view class="modal-overlay" catchtap="closeAIAnalysis"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">AIæŠ¥è¡¨åˆ†æ</text>
      <view class="close-btn" bindtap="closeAIAnalysis">âœ•</view>
    </view>
    <view class="modal-body">
      <view class="analysis-info">
        <text class="info-label">åˆ†ææœŸé—´</text>
        <text class="info-value">{{selectedPeriod}}</text>
      </view>
      <view class="analysis-data">
        <view class="data-item">
          <text class="data-label">æ”¶å…¥</text>
          <text class="data-value income">Â¥{{periodIncome}}</text>
        </view>
        <view class="data-item">
          <text class="data-label">æ”¯å‡º</text>
          <text class="data-value expense">Â¥{{periodExpense}}</text>
        </view>
        <view class="data-item">
          <text class="data-label">ç»“ä½™</text>
          <text class="data-value balance">Â¥{{periodBalance}}</text>
        </view>
      </view>
      <button class="analyze-btn" bindtap="analyzeReportWithAI" disabled="{{loadingAI}}">
        {{loadingAI ? 'AIåˆ†æä¸­...' : 'å¼€å§‹AIåˆ†æ'}}
      </button>
      <view class="result-section" wx:if="{{aiAnalysisResult}}">
        <text class="result-label">åˆ†æç»“æœ</text>
        <text class="result-text">{{aiAnalysisResult}}</text>
      </view>
    </view>
  </view>
</view>
